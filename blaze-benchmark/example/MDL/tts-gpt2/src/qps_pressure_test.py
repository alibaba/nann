import time
import requests
from multiprocessing.dummy import Pool as ThreadPool

def fun(item_id):
    tic = time.time()
    #url = f'http://text-generation-design-point-opt.vipserver/rttm/dp?entity_id={item_id}'
    url = f'http://127.0.0.1:8888/rttm/dp?entity_id={item_id}'
    r = requests.get(url)  # rt
    if r.status_code==200:
        if "false" in r.text:
            print('error')
            return None
        rt = time.time()-tic
        return [rt,r.json()]
    else:
        print('error')
        return None

item_ids = [
    '610355805340',
    '642058233037',
    '643557488092',
    '614012622646',
    '629553595088',
    '642254564351',
    '644862498099',
    '19478096364',
    '587914782354',
    '640260161316',
    '641919812154',
    '639922576127',
    '539111486574',
    '618152260082',
    '641437088746',
    '640353462577',
    '617449129363',
    '641668581835',
    '537598154212',
    '646854980122',
    '613274785669',
    '567609110867',
    '644222415569',
    '537251776494',
    '643614426529',
    '41315983463',
    '594420793081',
    '560250007807',
    '644511665965',
    '642089809110',
    '649380831740',
    '620444259640',
    '637847219515',
    '641369401473',
    '642446093164',
    '614188282185',
    '637746379956',
    '618329307603',
    '648982073043',
    '639781247324',
    '642204372583',
    '617785667722',
    '646871505908',
    '622313043589',
    '641213199407',
    '641877293145',
    '611111890382',
    '641806458131',
    '647533581718',
    '625368801561',
    '641462941719',
    '641480494678',
    '611489610783',
    '640101885949',
    '619695014812',
    '586809134182',
    '643922569864',
    '587779764344',
    '590248127243',
    '641640718723',
    '617204590062',
    '641378174184',
    '642507945862',
    '562346952267',
    '646950099027',
    '641581636083',
    '618325059414',
    '621496912829',
    '639645510567',
    '586716860431',
    '639107317572',
    '646139000184',
    '617193313902',
    '642563650302',
    '641371854324',
    '639623692789',
    '640085826478',
    '641764908467',
    '643124297675',
    '566736402567',
    '567609110867',
    '614817846012',
    '586658505949',
    '641864825834',
    '625368673254',
    '640262488943',
    '641373888318',
    '641135867390',
    '645507122671',
    '640726084555',
    '609041315027',
    '638047056960',
    '639846313130',
    '642728985256',
    '618156072378',
    '647252647652',
    '596600872747',
    '644398759806',
    '643290168312',
    '641973479510',
    '644833649904',
    '640499736063',
    '640121831616',
    '639562418861',
    '647631992652',
    '594053820585',
    '642988979412',
    '571105537574',
    '642525128080',
    '637068455361',
    '624525265062',
    '619067402871',
    '647323350824',
    '641521316165',
    '642580960771',
    '649340938500',
    '642502639090',
    '600965632793',
    '618340767668',
    '43853417281',
    '638830744224',
    '641582096190',
    '642442595482',
    '619179520323',
    '612309164806',
    '640781104882',
    '643322848532',
    '637833455225',
    '647209650912',
    '608674485743',
    '637985326066',
    '640316571341',
][:100] # 取100个
#item_ids *= 2 # copy成两份，200个
#

print(f'测试样本数 = {len(item_ids)}')

n_test = 3 # 测试轮数
for i in range(n_test):
    print(f'\n第{i+1}轮测试：')
    for pool_size in [2]:
        tic = time.time()

        pool = ThreadPool(pool_size) # 设置并发数
        results = pool.map(fun, item_ids) # starmap()支持多参数。map()不支持多参数

        rts = [r[0] for r in results if r!=None] # 统计非None的rt数
        avg_rt = sum(rts)/len(rts)               # 计算平均耗时
        n_errors = sum([1 for r in results if r==None])  # 统计None的数，即为运行错误的数

        costTime=time.time()-tic  # 总耗时
        print(f'并发数pool_size = {pool_size}  costTime = {costTime:.2f}s  avgTime = {costTime/len(item_ids):.2f}s  QPS = {len(item_ids)/costTime:.2f}  avg_rt={avg_rt:.2f}s  #errors={n_errors}')
        time.sleep(20) # 每次测试完间隔20s，避免对下一次造成影响

    time.sleep(60) # 每次测试完间隔60s，避免对下一次造成影响

