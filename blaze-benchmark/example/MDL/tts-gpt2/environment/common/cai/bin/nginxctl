#!/bin/bash

ARGV="$@"
cd $(dirname $0)/..
BASE=$(pwd)
BASE_CONF_DIR="$BASE/conf"

# if set to "1", skip use RUNNING_CONF_DIR
test -z "$RUNNING_SKIP" && RUNNING_SKIP=0
if [ "$RUNNING_SKIP" -ne 1 ]; then
    RUNNING_CONF_DIR="$BASE/.running_conf"
    NGINX="/opt/taobao/tengine/bin/tengine -c $RUNNING_CONF_DIR/nginx-proxy.conf -p $BASE"
else
    NGINX="/opt/taobao/tengine/bin/tengine -c $BASE_CONF_DIR/nginx-proxy.conf -p $BASE"
fi
NGINX_PID="$BASE/logs/tengine-proxy.pid"
CURL="/usr/bin/curl"
STATUSURL="http://localhost:80/status.taobao"

ULIMIT_MAX_FILES="ulimit -S -n $(ulimit -H -n)"

if [ "x$ULIMIT_MAX_FILES" != "x" ] ; then
    $ULIMIT_MAX_FILES
fi

ERROR=0

if [ "x$ARGV" = "x" ] ; then
    echo "$0 {start|stop|restart|reload|quit|rotate|status|upgrade}"
    exit 0
fi

merge_conf() {
    if [ "$RUNNING_SKIP" -ne 1 ]; then
        echo "init $RUNNING_CONF_DIR/"
        rm -fr $RUNNING_CONF_DIR/ && mkdir -p $RUNNING_CONF_DIR/
        echo "copy from /opt/taobao/tengine/conf/  to  $RUNNING_CONF_DIR/"
        rsync -a -r --copy-unsafe-links /opt/taobao/tengine/conf/ $RUNNING_CONF_DIR/
        echo "copy from $BASE_CONF_DIR/   to  $RUNNING_CONF_DIR/"
        rsync -a -r --copy-unsafe-links $BASE_CONF_DIR/ $RUNNING_CONF_DIR/
        echo "init $RUNNING_CONF_DIR/ done"
    fi
}

online() {
    touch -m $STATUSROOT_HOME/status.taobao
    echo "app auto online..."
}

offline() {
    rm -f $STATUSROOT_HOME/status.taobao
    echo "wait app offline..."
    sleep 15
}

stop_old_nginx_proxy() {
    echo "stop old nginx-proxy"
    killall -9 nginx-proxy
}

if [ ! -d "$BASE/data" ] ; then
    mkdir $BASE/data
fi

case "$ARGV" in
offline)
    offline
;;
online)
    online
;;
    start)
    merge_conf
    stop_old_nginx_proxy
    echo "$NGINX"
    $NGINX
    ERROR=$?
    ;;
    stop|reload|quit)
    if [ $ARGV = "reload" ];then
        merge_conf
    fi
    echo "$NGINX $ARGV"
    nginx_stoped=`ps auxf | grep tengine | wc -l`
    if [ $nginx_stoped -eq 1 ]; then
        echo "Nginx is already stoped"
        exit 0
    else
        $NGINX -s $ARGV
        ERROR=$?
    fi
    ;;
    restart)
    if [ -f $NGINX_PID ] ; then
        echo "$NGINX -s stop"
        $NGINX -s stop
        ERROR=$?
        [ $ERROR -eq 0 ] || exit $ERROR
        sleep 1
    fi
    merge_conf
    echo "$NGINX"
    $NGINX
    ERROR=$?
    ;;
    rotate)
    echo "$NGINX -s reopen"
    $NGINX -s reopen
    ERROR=$?
    ;;
    status)
    $CURL $STATUSURL
    ;;
    configtest)
    merge_conf
    echo "$NGINX -t"
    $NGINX -t
    ERROR=$?
    ;;
    upgrade)
    echo "Nginx upagrading, fork the new master and worker processes."
    if [ ! -f $NGINX_PID ] ; then
        $NGINX
        exit $?
    fi
    merge_conf
    kill -USR2 `cat $NGINX_PID`
    ERROR=$?
    if [ $ERROR -ne 0 ] ; then
        echo "Fork failed and check your configure or your $NGINX_PID."
        exit $ERROR
    fi
    sleep 1
    echo "Done, stop the old master and worker processes gracefully "
    kill -QUIT `cat $NGINX_PID.oldbin`
    ERROR=$?
    ;;
    *)
    $NGINX $ARGV
    ERROR=$?
esac

exit $ERROR